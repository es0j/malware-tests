
#include "syscalls.h"

NTSTATUS NtProtectVirtualMemory(
	IN HANDLE ProcessHandle,
	IN OUT PVOID * BaseAddress,
	IN OUT PSIZE_T RegionSize,
	IN ULONG NewProtect,
	OUT PULONG OldProtect){

    typedef NTSTATUS(WINAPI* PNtProtectVirtualMemory)(
        IN HANDLE ProcessHandle,
        IN OUT PVOID * BaseAddress,
        IN OUT PSIZE_T RegionSize,
        IN ULONG NewProtect,
        OUT PULONG OldProtect
    );

    PNtProtectVirtualMemory NtProtectVirtualMemoryNative 
    = (PNtProtectVirtualMemory)GetProcAddress(GetModuleHandleA("ntdll.dll"), "NtProtectVirtualMemory");
    NTSTATUS status = NtProtectVirtualMemoryNative(
        ProcessHandle,
        BaseAddress,
        RegionSize,
        NewProtect,
        OldProtect
    );
    return status;
}

NTSTATUS NtWriteVirtualMemory(
	IN HANDLE ProcessHandle,
	IN PVOID BaseAddress,
	IN PVOID Buffer,
	IN SIZE_T NumberOfBytesToWrite,
	OUT PSIZE_T NumberOfBytesWritten OPTIONAL){

    typedef NTSTATUS(WINAPI* PNtWriteVirtualMemory)(
        IN HANDLE ProcessHandle,
        IN PVOID BaseAddress,
        IN PVOID Buffer,
        IN SIZE_T NumberOfBytesToWrite,
        OUT PSIZE_T NumberOfBytesWritten OPTIONAL
    );

    PNtWriteVirtualMemory NtWriteVirtualMemoryNative = 
    (PNtWriteVirtualMemory)GetProcAddress(GetModuleHandleA("ntdll.dll"), "NtWriteVirtualMemory");

    NTSTATUS status = NtWriteVirtualMemoryNative(
        ProcessHandle,
        BaseAddress,
        Buffer,
        NumberOfBytesToWrite,
        NumberOfBytesWritten
    );
    return status;

}

NTSTATUS NtAllocateVirtualMemory(
        IN HANDLE ProcessHandle,
        IN OUT PVOID * BaseAddress,
        IN ULONG ZeroBits,
        IN OUT PSIZE_T RegionSize,
        IN ULONG AllocationType,
        IN ULONG Protect){

    typedef NTSTATUS(WINAPI* PNTALLOCATEVIRTUALMEMORY)(
        IN HANDLE ProcessHandle,
        IN OUT PVOID * BaseAddress,
        IN ULONG ZeroBits,
        IN OUT PSIZE_T RegionSize,
        IN ULONG AllocationType,
        IN ULONG Protect
    );

    PNTALLOCATEVIRTUALMEMORY NtAllocateVirtualMemoryNative = 
    (PNTALLOCATEVIRTUALMEMORY)GetProcAddress(GetModuleHandleA("ntdll.dll"), "NtAllocateVirtualMemory");
    
    NTSTATUS status = NtAllocateVirtualMemoryNative(
        ProcessHandle,
        BaseAddress,
        ZeroBits,
        RegionSize,
        AllocationType,
        Protect
    );
    return status;
}



NTSTATUS NtCreateThreadEx(
	OUT PHANDLE ThreadHandle,
	IN ACCESS_MASK DesiredAccess,
	IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,
	IN HANDLE ProcessHandle,
	IN PVOID StartRoutine,
	IN PVOID Argument OPTIONAL,
	IN ULONG CreateFlags,
	IN SIZE_T ZeroBits,
	IN SIZE_T StackSize,
	IN SIZE_T MaximumStackSize,
	IN PPS_ATTRIBUTE_LIST AttributeList OPTIONAL){


    typedef NTSTATUS(WINAPI* PNtCreateThreadEx)(
        OUT PHANDLE ThreadHandle,
        IN ACCESS_MASK DesiredAccess,
        IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,
        IN HANDLE ProcessHandle,
        IN PVOID StartRoutine,
        IN PVOID Argument OPTIONAL,
        IN ULONG CreateFlags,
        IN SIZE_T ZeroBits,
        IN SIZE_T StackSize,
        IN SIZE_T MaximumStackSize,
        IN PPS_ATTRIBUTE_LIST AttributeList OPTIONAL
    );

    PNtCreateThreadEx NtCreateThreadExNative = (PNtCreateThreadEx)GetProcAddress(GetModuleHandleA("ntdll.dll"), "NtCreateThreadEx");
    NTSTATUS status = NtCreateThreadExNative(
        ThreadHandle,
        DesiredAccess,
        ObjectAttributes,
        ProcessHandle,
        StartRoutine,
        Argument,
        CreateFlags,
        ZeroBits,
        StackSize,
        MaximumStackSize,
        AttributeList
    );
    return status;
}

NTSTATUS NtWaitForSingleObject(
	IN HANDLE ObjectHandle,
	IN BOOLEAN Alertable,
	IN PLARGE_INTEGER TimeOut OPTIONAL){


    typedef NTSTATUS(WINAPI* PNtWaitForSingleObject)(
        IN HANDLE ObjectHandle,
        IN BOOLEAN Alertable,
        IN PLARGE_INTEGER TimeOut OPTIONAL
    );

    PNtWaitForSingleObject NtWaitForSingleObjectNative = (PNtWaitForSingleObject)GetProcAddress(GetModuleHandleA("ntdll.dll"), "NtWaitForSingleObject");
    NTSTATUS status = NtWaitForSingleObjectNative(
        ObjectHandle,
        Alertable,
        TimeOut
    );
    return status;
}


NTSTATUS NtClose(
	IN HANDLE Handle){

    typedef NTSTATUS(WINAPI* PNtClose)(
        IN HANDLE Handle
        );

    PNtClose NtCloseNative = (PNtClose)GetProcAddress(GetModuleHandleA("ntdll.dll"), "NtClose");
    NTSTATUS status = NtCloseNative(
        Handle
    );
    return status;

}