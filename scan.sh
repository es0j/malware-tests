#!/bin/bash

highlight () { grep --color -E "$1|$" "${@:1}" ; }
fname=$1


function scan() {
    fname=$1
    ThreatCheck.exe -e Defender -f $fname | tee evilOffsets.txt
    for p in $(cat  evilOffsets.txt | grep 'Identified end of bad' |grep -Eo '0x[0-9a-fA-F]+' )
    do
        local start=$(python3 -c "print($p-0x50)")
        local end=$(python3 -c "print($p+0x50)")
        local find=$(python3 -c "print(hex($p)[2:])")

        echo "Evil bytes at" $find
        objdump -D -Mintel,x86-64 -b binary --start-address=$start --stop-address=$end -m i386 -f $fname | grep --color -E "$find|$"
    done

    rm evilOffsets.txt 
}

scan $fname